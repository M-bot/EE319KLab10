#include <stdint.h>
#include "Graphics2D.h"
#include "ST7735.h"
#include "Timer0.h"

#define WIDTH 160
#define HEIGHT 128
#define ROOM_WIDTH 160
#define ROOM_HEIGHT 90 

uint16_t pixels[ROOM_WIDTH*ROOM_HEIGHT];

const unsigned short ene[] = {
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000,
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
};

void Graphics2DInit(void) {
	// Inititalize the display
  ST7735_InitR(INITR_REDTAB);
	// Set screen to landscape
  ST7735_SetRotation(1);
	// Set render frequency to 30 fps (assuming 80 MHz PLL)
  Timer0_Init(&Render,80000000/30);
}

void ClearBuffer(void) {
	// Clears to black, should clear to current background
	for(int p = 0; p < ROOM_WIDTH*ROOM_HEIGHT; p++) {
	  pixels[p] = 0x32D3;
	}
}

uint16_t cur;
void Render(void) {
	ClearBuffer();
	DrawImage(cur,cur,ene,16,10);
  ST7735_DrawBitmap(0,HEIGHT,pixels,ROOM_WIDTH,ROOM_HEIGHT);
	cur = (cur + 5) % ROOM_HEIGHT;
}

void DrawImage(uint16_t x, uint16_t y, const uint16_t * image, uint16_t w, uint16_t h) {
	// Perform clipping on the image so it fits in the room
  int16_t hh = h,ww = w;
	if((y+h) >= ROOM_HEIGHT)
		hh = ROOM_HEIGHT - y - 1;
	if((x+w) >= ROOM_WIDTH)
		ww = ROOM_WIDTH - x - 1;
	
	// Draw image to buffer
	for(int r = 0; r < hh; r++) {
	  for(int c = 0; c < ww; c++) {
			if(!image[r*w+c]) continue; 
			pixels[(y+r)*ROOM_WIDTH+x+c] = image[r*w+c];
		}
	}	
}
